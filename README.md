# 3sem_lr2

# Лабораторная работа №2
------

## Основное задание
Разработать и реализовать клиент-серверную информационную систему, реализующую мехнизм CRUD. Система представляет собой веб-страницу с лентой заметок и форму добавления новой заметки. Система должна обладать следующим функционалом:
 - Добавление текстовых заметок в общую ленту
 - Реагирование на чужие заметки (лайки)
 
## Дополнительные задания

В качестве дополнительного функционала можно реализовать следующие задачи:

 - Добавление комментариев к чужим заметкам
 - "Раскрывающиеся" комментарии
 - Комментирование второго уровня
 
## Ход работы

### 1. Разработка пользовательского интерфейса

- Главная страница

![Рис.1 - Главная страница](https://github.com/tagathlet/3sem_lr2/blob/main/StartPage.png)


- Главная страница с раскрытыми комментариями

![Рис.2 - Главная страница с раскрытыми комментариями](https://github.com/tagathlet/3sem_lr2/blob/main/PageWithComments.png)


### 2. Описание пользовательских сценариев работы
На сайте пользователю доступны следующие возможности:
- Опубликовать новую запись на форуме
- Поставить реакцию на опубликованные ранее записи
- Комментировать запись или комментарии к ней
- Перемещение по страницам форума и чтение старых записей ( на главной странице последние 5 )

Если пользователь попытается опубликовать запись с большим объемом текста (более 900 символов), с маленьким объемом текста (менее 4 символов) ему будет показано сообщение об ошибке.

Если пользователь сделал все правильно, то после нажатия на кнопку "Отправить", страница форума обновится и среди всех записей появится новая запись от пользователя.

Количество реакций от одного пользователя не ограничено. Если число реакции на записи достигнет значения 999, при попытке оставить эту реакцию появится сообщение об ошибке.

Пользователь может прокомментировать запись или оставить комментарий второго уровня на другие комментарии к этой записи. Если объем комментария будет меньше 4 символов или больше 200 символов, появится сообщение об ошибке. Если объем комментария соответствует условиям, то после нажатия на кнопку "Ответить", страница обновится и к записи добавится новый комментарий.


### 3. Описание API сервера и хореографии

- Пример запросов, когда пользователь оставляет новую запись:
<p align = "center"><img src="https://ic.wampi.ru/2022/11/25/new_post.png"/width = 370></p>
Post запрос содержит следующие данные: данные об изображении и текст записи

- Пример запросов, когда пользователь оставляет реакцию на запись:
<p align = "center"><img src="https://im.wampi.ru/2022/11/25/reaction.png"/width = 370></p>

- Пример запросов, когда пользователь оставляет комментарий:
<p align = "center"><img src="https://ic.wampi.ru/2022/11/25/comment.png"/width = 370></p>
Post запрос содержит следующие данные: текст комментария, текущую страницу форума и id записи, которую комментируют. В случае, если это комментарий второго уровня, id записи заменяется на id комментария.

- Пример запросов, когда пользователь перемешается между страницами:
<p align = "center"><img src="https://ie.wampi.ru/2022/11/25/Page.png"/width = 300></p>


### 4. Описание структуры базы данных

Для хранения данных форума используется база данных MySQL. Всего в базе данных содержится 3 таблицы: таблица с информацией о записях на форуме, таблица с информацией о комментариях и таблица с информацией о комментариях второго уровня.

Таблица о записях на форуме содержит в себе индивидуальный номер записи, текст записи, количество лайков.

Пример записи на форуме в базе данных:

```sh
{
    "id": 3,
    "text": "Третий пост на форуме",
    "like_count": 5,
    }
```

Таблица о комментариях на форуме содержит в себе индивидуальный номер комментария, текст комментария, индивидуальный номер записи, к которой относится комментарий.

Пример записи о комментарии в базе данных:

```sh
{
    "id": 3,
    "text": "Первый комментарий к этой записи",
    "post_id": 52
}
```

Таблица о комментариях второго уровня на форуме содержит в себе индивидуальный номер комментария, текст комментария, индивидуальный номер комментария, к которому относится комментарий.

Пример записи о комментарии второго уровня в базе данных:

```sh
{
    "id": 1,
    "text": "Первый комментарий 2-го уровня",
    "comment_id": 3
}
```

### 5. Описание алгоритмов

- Пользователь добавляет новую запись с картинкой:
<p align = "center"> <img src="https://github.com/tagathlet/3sem_lr2/blob/main/DiagAlgPosts.png" width = "400"> </p>


- Пользователь оставляет комментарий:
<p align = "center"><img src="https://github.com/tagathlet/3sem_lr2/blob/main/Diag_NewComm.png" width = "400"/></p>


- Пользователь оставляет реакцию:
<p align = "center"><img src="https://github.com/tagathlet/3sem_lr2/blob/main/DiagLike.png" width = "300"/></p>


- Пользователь переключается между страницами:
<p align = "center"><img src="https://github.com/tagathlet/3sem_lr2/blob/main/DiagPages.png" width = "120"/></p>

- Алгоритм выдачи постов:
<p align = "center"><img src="https://github.com/tagathlet/3sem_lr2/blob/main/DiagAlgPosts.png" width = "200"/></p>


## Значимые фрагменты кода
Фрагмент кода, запрашивающий записи о постах из базы данных:
```sh
$link = mysqli_connect("localhost", "admin", "admin", "lab2_bd");

mysqli_set_charset($link, "utf8");

$sql = 'SELECT * FROM posts ORDER BY time DESC';

$result = mysqli_query($link, $sql);
$max_posts = mysqli_num_rows($result);
$result = mysqli_fetch_all($result, MYSQLI_ASSOC);
```

Фрагмент кода, содержащий скрипты для "раскрывающихся" комментариев
```sh
<script> 
	function show_comments(id){
		let c = document.getElementById("c"+id);
		c.removeAttribute("hidden");
		
		let b = document.getElementById("b"+id);
		b.textContent = "Скрыть комментарии";
		
		b.setAttribute("onClick", "hide_comments('"+id+"')");
	}
	
	function hide_comments(id) {
		let c = document.getElementById("c"+id);
		c.setAttribute("hidden", true);
		
		let b = document.getElementById("b"+id);
		b.textContent = "Показать комментарии";
		
		b.setAttribute("onClick", "show_comments('"+id+"')");
	}
</script>
```

Фрагмент кода выдачи постов: 
```sh
<?php
	$max_page_posts = 100;
				
	$page = 1;
	if (isset($_GET["page"]) && $_GET["page"] > 0)
		$page = $_GET["page"];
			
	if (($page - 1) * $max_page_posts >= $max_posts)
		$page = ceil($max_posts / $max_page_posts); 
			
	for ($i = 1 + ($max_page_posts * ($page - 1)); $i <= ($max_page_posts*$page); $i++) {				
		
		if ($i > $max_posts)
			break;
				
		[$text, $like, $post_id] = parse_post($i - 1, $result);
		[$comments, $comm_count, $c_id, $sub_comm_count] = parse_comment($post_id, $comments_db);
				
		echo "<tr> <td>";
		include ("template/post.php");
		echo "</td></tr>";
				
		echo "<tr height = 5> </tr>";
		echo "<tr><td>";
		include ("template/comments.php"); 
		echo "</td></tr>";
				
		echo "<tr height = 20> <td> <hr> <td> </tr>";
	}
		
?>
```

Фрагмент кода, создающий новую запись о посте в базе данных:
```sh
$sql = "INSERT INTO `posts` (`id`, `text`, `like_count`) VALUES (NULL, '".$text."', '0');";
	
$link = mysqli_connect("localhost", "admin", "admin", "lab2_bd");
mysqli_set_charset($link, "utf8");
$res = mysqli_query($link, $sql);
```
